name: Daily Cache Refresh

on:
  schedule:
    # 4:30 PM ET = 21:30 UTC (EST) or 20:30 UTC (EDT)
    # Using 21:30 for winter, adjust if needed
    - cron: '30 21 * * 1-5'  # Weekdays only
  workflow_dispatch:  # Manual trigger

jobs:
  refresh-cache:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install shared-core
        run: |
          cd 000-099-investing/000-shared-core
          pip install -e .
      
      - name: Install 007-ticker-analysis dependencies
        run: |
          cd 000-099-investing/007-ticker-analysis
          pip install -r requirements.txt
      
      - name: Create config.json from secrets
        run: |
          cd 000-099-investing/007-ticker-analysis
          cat > config.json << 'EOF'
          {
            "google_sheets": {
              "credentials_file": "google_service_account.json",
              "spreadsheet_name": "${{ secrets.GSHEET_NAME }}",
              "main_tab": "Sheet1",
              "ticker_column": "A",
              "start_row": 2,
              "tech_data_tab": "Tech_Data",
              "transcripts_tab": "Transcripts"
            },
            "twelve_data": {
              "api_key": "${{ secrets.TWELVE_DATA_API_KEY }}",
              "output_size": 365,
              "rate_limit_sleep": 8.0
            },
            "grok": {
              "api_key": "${{ secrets.GROK_API_KEY }}",
              "model": "grok-4-1-fast-reasoning",
              "summarization_enabled": false,
              "max_summary_tokens": 400
            },
            "defeatbeta": {
              "quarters_to_fetch": 1,
              "min_chars": 600,
              "earliest_year_offset": 1
            }
          }
          EOF
      
      - name: Set up Google credentials
        run: |
          cd 000-099-investing/007-ticker-analysis
          echo '${{ secrets.GDRIVE_API_KEY_JSON }}' > google_service_account.json
      
      - name: Run cache refresh
        env:
          TWELVE_DATA_API_KEY: ${{ secrets.TWELVE_DATA_API_KEY }}
        run: |
          cd 000-099-investing/007-ticker-analysis
          python run_all.py --cache-only 2>&1 || python sheet_data_loader.py --tech-only 2>&1 || echo "Cache refresh completed with warnings"
      
      - name: Commit cache files
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add 000-099-investing/007-ticker-analysis/data/ || true
          git diff --staged --quiet || git commit -m "chore: daily cache refresh $(date +%Y-%m-%d)"
          git push || echo "No changes to push"
      
      - name: Trigger downstream workflows
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          event-type: cache-refreshed
          client-payload: '{"date": "${{ github.run_id }}"}'

  # Notify on failure
  notify-failure:
    runs-on: ubuntu-latest
    needs: refresh-cache
    if: failure()
    steps:
      - name: Send failure notification
        env:
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
        run: |
          curl -X POST https://api.resend.com/emails \
            -H "Authorization: Bearer $RESEND_API_KEY" \
            -H "Content-Type: application/json" \
            -d '{
              "from": "alexb@novaconsultpro.com",
              "to": ["ab00477@icloud.com", "alexbespalovtx@gmail.com"],
              "subject": "Cache Refresh Failed - '"$(date +%b\ %d)"'",
              "html": "<h2>Daily Cache Refresh Failed</h2><p>Check GitHub Actions for details.</p>"
            }'

